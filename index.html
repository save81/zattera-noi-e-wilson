<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Progetto Zattera-NOI-E-WILSON - Estate 2026</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Lobster&family=Nunito:wght@400;600;700;800&display=swap');

  :root {
    --ocean-deep: #0B3D6B;
    --ocean-mid: #1565A0;
    --ocean-light: #4FC3F7;
    --sand: #F5E6C8;
    --sand-dark: #D4A86A;
    --wood: #8B5E3C;
    --wood-light: #C49A6C;
    --wood-dark: #5D3A1A;
    --sun: #FFD54F;
    --coral: #FF7043;
    --foam: #E0F7FA;
    --green: #4CAF50;
    --red: #E53935;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(180deg, var(--ocean-deep) 0%, var(--ocean-mid) 40%, var(--ocean-light) 70%, var(--sand) 95%);
    min-height: 100vh;
    color: #1a1a1a;
    overflow-x: hidden;
  }

  /* Waves animation */
  .waves {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.15;
  }
  .wave {
    position: absolute;
    width: 200%;
    height: 200px;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 40px,
      rgba(255,255,255,0.15) 40px,
      rgba(255,255,255,0.15) 80px
    );
    border-radius: 50%;
    animation: wave-move 8s ease-in-out infinite;
  }
  .wave:nth-child(1) { top: 15%; animation-delay: 0s; opacity: 0.4; }
  .wave:nth-child(2) { top: 35%; animation-delay: -2s; opacity: 0.3; }
  .wave:nth-child(3) { top: 55%; animation-delay: -4s; opacity: 0.2; }

  @keyframes wave-move {
    0%, 100% { transform: translateX(-25%); }
    50% { transform: translateX(0%); }
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  /* Header */
  .header {
    text-align: center;
    padding: 3rem 0 2rem;
    animation: fadeInDown 0.8s ease;
  }
  .header h1 {
    font-family: 'Lobster', cursive;
    font-size: 3.5rem;
    color: white;
    text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
    margin-bottom: 0.5rem;
  }
  .header .subtitle {
    font-size: 1.2rem;
    color: var(--sand);
    font-weight: 600;
  }
  .header .castaway-badge {
    display: inline-block;
    margin-top: 1rem;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.25);
    border-radius: 50px;
    padding: 0.5rem 1.5rem;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 1px;
  }

  @keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Cards */
  .card {
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    animation: fadeInUp 0.6s ease forwards;
    opacity: 0;
  }
  .card:nth-child(1) { animation-delay: 0.1s; }
  .card:nth-child(2) { animation-delay: 0.2s; }
  .card:nth-child(3) { animation-delay: 0.3s; }
  .card:nth-child(4) { animation-delay: 0.4s; }
  .card:nth-child(5) { animation-delay: 0.5s; }
  .card:nth-child(6) { animation-delay: 0.6s; }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--ocean-deep);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .card-title .icon {
    font-size: 1.8rem;
  }

  /* Calculator Section */
  .calc-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  @media (max-width: 600px) { .calc-grid { grid-template-columns: 1fr; } }

  .calc-field label {
    display: block;
    font-weight: 700;
    font-size: 0.85rem;
    color: #555;
    margin-bottom: 0.3rem;
  }
  .calc-field input, .calc-field select {
    width: 100%;
    padding: 0.7rem 1rem;
    border: 2px solid #ddd;
    border-radius: 12px;
    font-size: 1rem;
    font-family: 'Nunito', sans-serif;
    transition: border-color 0.3s;
  }
  .calc-field input:focus, .calc-field select:focus {
    outline: none;
    border-color: var(--ocean-light);
  }

  .result-box {
    background: linear-gradient(135deg, var(--ocean-deep), var(--ocean-mid));
    border-radius: 16px;
    padding: 1.5rem;
    color: white;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
  }
  .result-item {
    text-align: center;
  }
  .result-item .number {
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--sun);
  }
  .result-item .label {
    font-size: 0.8rem;
    opacity: 0.85;
    margin-top: 0.2rem;
  }

  .warning-box {
    background: #FFF3E0;
    border-left: 4px solid #FF9800;
    border-radius: 0 12px 12px 0;
    padding: 1rem 1.2rem;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #E65100;
  }

  /* Raft Visual */
  .raft-visual {
    position: relative;
    width: 100%;
    max-width: 500px;
    margin: 1rem auto;
  }
  .raft-svg-container {
    width: 100%;
    aspect-ratio: 4 / 3;
  }
  .raft-svg-container svg {
    width: 100%;
    height: 100%;
  }

  .dimensions-label {
    text-align: center;
    font-weight: 700;
    color: var(--ocean-deep);
    margin-top: 0.5rem;
    font-size: 0.95rem;
  }

  /* Materials List */
  .materials-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  .materials-table th {
    background: var(--ocean-deep);
    color: white;
    padding: 0.8rem 1rem;
    text-align: left;
    font-weight: 700;
    font-size: 0.85rem;
  }
  .materials-table th:first-child { border-radius: 12px 0 0 0; }
  .materials-table th:last-child { border-radius: 0 12px 0 0; }
  .materials-table td {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }
  .materials-table tr:nth-child(even) { background: #f7fafc; }
  .materials-table tr:last-child td:first-child { border-radius: 0 0 0 12px; }
  .materials-table tr:last-child td:last-child { border-radius: 0 0 12px 0; }

  /* Steps */
  .step {
    display: flex;
    gap: 1.2rem;
    margin-bottom: 1.5rem;
    align-items: flex-start;
  }
  .step-num {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--ocean-mid), var(--ocean-light));
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 1.2rem;
    box-shadow: 0 4px 12px rgba(21, 101, 160, 0.35);
  }
  .step-content h3 {
    font-size: 1.05rem;
    font-weight: 800;
    color: var(--ocean-deep);
    margin-bottom: 0.3rem;
  }
  .step-content p {
    font-size: 0.9rem;
    color: #555;
    line-height: 1.6;
  }

  /* Checklist */
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.7rem 0.5rem;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
    border-radius: 8px;
  }
  .checklist-item:hover { background: #f7fafc; }
  .checklist-item input[type="checkbox"] {
    width: 22px;
    height: 22px;
    accent-color: var(--green);
    cursor: pointer;
    flex-shrink: 0;
  }
  .checklist-item.done .item-text {
    text-decoration: line-through;
    color: #aaa;
  }
  .item-text { font-size: 0.95rem; flex: 1; }
  .item-category {
    font-size: 0.7rem;
    font-weight: 700;
    background: var(--ocean-light);
    color: white;
    padding: 0.15rem 0.5rem;
    border-radius: 6px;
    flex-shrink: 0;
  }
  .item-category.safety { background: var(--coral); }
  .item-category.tool { background: var(--wood); }

  .progress-bar-bg {
    width: 100%;
    height: 12px;
    background: #e0e0e0;
    border-radius: 6px;
    margin: 1rem 0;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--green), #66BB6A);
    border-radius: 6px;
    transition: width 0.5s ease;
  }
  .progress-text {
    text-align: center;
    font-weight: 700;
    color: var(--green);
    font-size: 0.9rem;
  }

  /* Safety section */
  .safety-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
  }
  @media (max-width: 600px) { .safety-grid { grid-template-columns: 1fr; } }

  .safety-item {
    background: #FFF8E1;
    border-radius: 12px;
    padding: 1rem;
    border: 2px solid #FFD54F;
  }
  .safety-item h4 {
    color: var(--coral);
    font-size: 0.95rem;
    margin-bottom: 0.3rem;
  }
  .safety-item p {
    font-size: 0.85rem;
    color: #555;
    line-height: 1.5;
  }

  /* Budget section */
  .budget-total {
    background: linear-gradient(135deg, var(--green), #388E3C);
    border-radius: 16px;
    padding: 1.5rem;
    color: white;
    text-align: center;
    margin-top: 1rem;
  }
  .budget-total .total-number {
    font-size: 2.5rem;
    font-weight: 800;
  }
  .budget-total .total-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  .budget-note {
    font-size: 0.8rem;
    color: #888;
    margin-top: 0.8rem;
    font-style: italic;
    text-align: center;
  }

  /* Timeline section */
  .timeline {
    position: relative;
    padding-left: 2rem;
    margin-top: 1rem;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 12px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--ocean-light), var(--ocean-deep));
    border-radius: 2px;
  }
  .timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -1.55rem;
    top: 6px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--ocean-mid);
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--ocean-light);
  }
  .timeline-item.highlight::before {
    background: var(--coral);
    box-shadow: 0 0 0 2px var(--coral);
  }
  .timeline-when {
    font-weight: 800;
    font-size: 0.9rem;
    color: var(--ocean-deep);
  }
  .timeline-what {
    font-size: 0.9rem;
    color: #555;
    margin-top: 0.15rem;
  }
  .timeline-who {
    font-size: 0.8rem;
    color: var(--ocean-light);
    font-weight: 700;
  }

  /* Info box */
  .info-box {
    background: #E3F2FD;
    border-left: 4px solid var(--ocean-mid);
    border-radius: 0 12px 12px 0;
    padding: 1rem 1.2rem;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #0D47A1;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 3rem 0;
    color: rgba(255,255,255,0.6);
    font-size: 0.85rem;
  }

  /* =====================================================
     FLOATING SAVE BUTTON
     ===================================================== */
  .fab-save {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--green), #388E3C);
    color: white;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(76, 175, 80, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .fab-save:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 28px rgba(76, 175, 80, 0.6);
  }
  .fab-save:active { transform: scale(0.95); }
  .fab-save.unsaved {
    animation: pulse-save 1.2s ease-in-out infinite;
    background: linear-gradient(135deg, var(--coral), #D32F2F);
    box-shadow: 0 4px 20px rgba(255, 112, 67, 0.6);
  }
  @keyframes pulse-save {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.12); }
  }
  .fab-save.unsaved:hover { animation: none; transform: scale(1.1); }
  .unsaved-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    border: 2px solid var(--coral);
    display: none;
  }
  .fab-save.unsaved .unsaved-badge { display: block; }

  /* Nickname bar */
  .nickname-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.8rem;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.8);
  }
  .nickname-bar .nick-name {
    font-weight: 800;
    color: var(--sun);
    cursor: pointer;
    border-bottom: 1px dashed rgba(255,255,255,0.4);
  }
  .nickname-bar .nick-name:hover { color: white; }

  /* Nickname modal */
  .nick-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .nick-overlay.open { opacity: 1; pointer-events: auto; }
  .nick-panel {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    width: 90%;
    max-width: 360px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .nick-panel h3 { color: var(--ocean-deep); margin-bottom: 0.5rem; }
  .nick-panel p { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
  .nick-panel input {
    width: 100%;
    padding: 0.7rem 1rem;
    border: 2px solid #ddd;
    border-radius: 12px;
    font-size: 1.1rem;
    font-family: 'Nunito', sans-serif;
    text-align: center;
    font-weight: 700;
  }
  .nick-panel input:focus { outline: none; border-color: var(--ocean-light); }
  .nick-panel button {
    margin-top: 1rem;
    padding: 0.7rem 2rem;
    border: none;
    border-radius: 12px;
    background: var(--ocean-mid);
    color: white;
    font-family: 'Nunito', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
  }
  .nick-panel button:hover { background: var(--ocean-deep); }

  /* Modified-by label */
  .mod-by {
    font-size: 0.65rem;
    color: #aaa;
    font-style: italic;
    margin-left: 0.3rem;
  }
  .mod-by-row {
    font-size: 0.65rem;
    color: #aaa;
    font-style: italic;
    display: block;
    margin-top: 2px;
  }
  .field-mod {
    font-size: 0.65rem;
    color: #aaa;
    font-style: italic;
    display: block;
    margin-top: 3px;
    min-height: 1em;
  }
  .fab-save .fab-label {
    position: absolute;
    right: 72px;
    background: #333;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 700;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .fab-save:hover .fab-label { opacity: 1; }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 6rem;
    right: 2rem;
    background: #333;
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 700;
    z-index: 1001;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
  .toast.success { background: var(--green); }
  .toast.error { background: var(--red); }

  /* =====================================================
     EDITABLE TABLE / CHECKLIST BUTTONS
     ===================================================== */
  .row-actions {
    display: flex;
    gap: 0.3rem;
    flex-shrink: 0;
  }
  .btn-icon {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, transform 0.15s;
  }
  .btn-icon:hover { transform: scale(1.1); }
  .btn-icon:active { transform: scale(0.9); }
  .btn-edit { background: #E3F2FD; color: var(--ocean-mid); }
  .btn-edit:hover { background: #BBDEFB; }
  .btn-delete { background: #FFEBEE; color: var(--red); }
  .btn-delete:hover { background: #FFCDD2; }

  .btn-add-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.8rem;
    margin-top: 0.8rem;
    border: 2px dashed #ccc;
    border-radius: 12px;
    background: transparent;
    color: #888;
    font-family: 'Nunito', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
  }
  .btn-add-row:hover {
    border-color: var(--ocean-mid);
    color: var(--ocean-mid);
    background: #f0f8ff;
  }

  /* Edit modal/overlay */
  .edit-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .edit-overlay.open {
    opacity: 1;
    pointer-events: auto;
  }
  .edit-panel {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    width: 90%;
    max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    transform: translateY(20px);
    transition: transform 0.25s;
  }
  .edit-overlay.open .edit-panel {
    transform: translateY(0);
  }
  .edit-panel h3 {
    font-size: 1.2rem;
    color: var(--ocean-deep);
    margin-bottom: 1rem;
  }
  .edit-panel .form-group {
    margin-bottom: 0.8rem;
  }
  .edit-panel .form-group label {
    display: block;
    font-weight: 700;
    font-size: 0.85rem;
    color: #555;
    margin-bottom: 0.3rem;
  }
  .edit-panel .form-group input,
  .edit-panel .form-group select {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 0.95rem;
    font-family: 'Nunito', sans-serif;
  }
  .edit-panel .form-group input:focus,
  .edit-panel .form-group select:focus {
    outline: none;
    border-color: var(--ocean-light);
  }
  .edit-panel .btn-row {
    display: flex;
    gap: 0.8rem;
    margin-top: 1.2rem;
  }
  .edit-panel .btn-confirm {
    flex: 1;
    padding: 0.7rem;
    border: none;
    border-radius: 12px;
    font-family: 'Nunito', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }
  .edit-panel .btn-confirm.primary {
    background: var(--ocean-mid);
    color: white;
  }
  .edit-panel .btn-confirm.primary:hover { background: var(--ocean-deep); }
  .edit-panel .btn-confirm.secondary {
    background: #eee;
    color: #555;
  }
  .edit-panel .btn-confirm.secondary:hover { background: #ddd; }

  /* Section label for auto vs manual materials */
  .section-label {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.15rem 0.5rem;
    border-radius: 6px;
    margin-left: 0.5rem;
    vertical-align: middle;
  }
  .section-label.auto { background: #E3F2FD; color: var(--ocean-mid); }
  .section-label.custom { background: #E8F5E9; color: var(--green); }

  /* =====================================================
     DRAG AND DROP
     ===================================================== */
  .drag-handle {
    cursor: grab;
    color: #ccc;
    font-size: 1.1rem;
    padding: 0 0.3rem;
    flex-shrink: 0;
    user-select: none;
    touch-action: none;
    transition: color 0.2s;
    line-height: 1;
  }
  .drag-handle:hover { color: var(--ocean-mid); }
  .drag-handle:active { cursor: grabbing; }

  .checklist-item.dragging,
  tr.dragging {
    opacity: 0.4;
    background: #e3f2fd !important;
  }
  .checklist-item.drag-over {
    border-top: 3px solid var(--ocean-mid);
    padding-top: calc(0.7rem - 3px);
  }
  tr.drag-over td {
    border-top: 3px solid var(--ocean-mid) !important;
  }
  /* Mobile touch: ghost preview */
  .drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    background: white;
    border-radius: 12px;
    padding: 0.6rem 1rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    font-family: 'Nunito', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--ocean-deep);
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.9;
  }
</style>
</head>
<body>

<div class="waves">
  <div class="wave"></div>
  <div class="wave"></div>
  <div class="wave"></div>
</div>

<div class="container">

  <div class="header">
    <h1>&#x1F6A3; Progetto Zattera NOI E WILSON </h1>
    <p class="subtitle">Estate 2026 — L'avventura in famiglia</p>
    <div class="castaway-badge">&#x1F3DD;&#xFE0F; ISPIRAZIONE CAST AWAY</div>
    <div class="nickname-bar">&#x1F464; Stai lavorando come: <span class="nick-name" id="nickDisplay" onclick="promptNickname()" title="Clicca per cambiare nome">...</span></div>
  </div>

  <!-- CALCULATOR -->
  <div class="card" style="animation-delay: 0.1s">
    <div class="card-title"><span class="icon">&#x1F9EE;</span> Calcolatore Galleggiamento</div>
    <p style="color:#666; margin-bottom:1rem; font-size:0.9rem;">Inserisci i dati per calcolare quanti boccioni servono e le dimensioni della zattera.</p>

    <div class="calc-grid">
      <div class="calc-field">
        <label>&#x1F465; Numero persone</label>
        <input type="number" id="numPersone" value="8" min="1" max="15" onchange="fieldChanged('numPersone')">
        <span class="field-mod" id="mod_numPersone"></span>
      </div>
      <div class="calc-field">
        <label>&#x2696;&#xFE0F; Peso medio per persona (kg)</label>
        <input type="number" id="pesoMedio" value="75" min="30" max="150" onchange="fieldChanged('pesoMedio')">
        <span class="field-mod" id="mod_pesoMedio"></span>
      </div>
      <div class="calc-field">
        <label>&#x1F4A7; Capienza boccioni (litri)</label>
        <select id="capienzaBoccione" onchange="fieldChanged('capienzaBoccione')">
          <option value="10">10 litri</option>
          <option value="15">15 litri</option>
          <option value="18" selected>18 litri</option>
          <option value="20">20 litri</option>
        </select>
        <span class="field-mod" id="mod_capienzaBoccione"></span>
      </div>
      <div class="calc-field">
        <label>&#x1F4D0; Margine di sicurezza</label>
        <select id="margine" onchange="fieldChanged('margine')">
          <option value="1.3">30% (consigliato)</option>
          <option value="1.5">50% (extra sicuro)</option>
          <option value="1.2">20% (minimo)</option>
        </select>
        <span class="field-mod" id="mod_margine"></span>
      </div>
    </div>

    <div class="result-box" id="risultati">
      <!-- filled by JS -->
    </div>

    <div class="warning-box" id="warningBox" style="display:none"></div>
  </div>

  <!-- SCHEMA VISIVO -->
  <div class="card" style="animation-delay: 0.2s">
    <div class="card-title"><span class="icon">&#x1F4D0;</span> Schema della Zattera</div>
    <p style="color:#666; margin-bottom:1rem; font-size:0.9rem;">Vista dall'alto e laterale con disposizione dei boccioni sotto il compensato.</p>

    <div class="raft-visual">
      <div class="raft-svg-container">
        <svg id="raftSvg" viewBox="0 0 500 380" xmlns="http://www.w3.org/2000/svg">
          <!-- Water background -->
          <defs>
            <linearGradient id="waterGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#4FC3F7" stop-opacity="0.3"/>
              <stop offset="100%" stop-color="#0B3D6B" stop-opacity="0.3"/>
            </linearGradient>
            <pattern id="woodPattern" width="20" height="10" patternUnits="userSpaceOnUse">
              <rect width="20" height="10" fill="#C49A6C"/>
              <line x1="0" y1="3" x2="20" y2="3" stroke="#B08050" stroke-width="0.5"/>
              <line x1="0" y1="7" x2="20" y2="7" stroke="#B08050" stroke-width="0.3"/>
            </pattern>
          </defs>

          <!-- Top view label -->
          <text x="30" y="25" font-family="Nunito, sans-serif" font-weight="800" font-size="14" fill="#0B3D6B">VISTA DALL'ALTO</text>

          <!-- Raft top view -->
          <rect x="60" y="40" width="180" height="130" rx="4" fill="url(#woodPattern)" stroke="#5D3A1A" stroke-width="2"/>

          <!-- Plank lines -->
          <line x1="60" y1="72" x2="240" y2="72" stroke="#8B5E3C" stroke-width="1" stroke-dasharray="4,3"/>
          <line x1="60" y1="105" x2="240" y2="105" stroke="#8B5E3C" stroke-width="1" stroke-dasharray="4,3"/>
          <line x1="60" y1="138" x2="240" y2="138" stroke="#8B5E3C" stroke-width="1" stroke-dasharray="4,3"/>

          <!-- Jugs visible as circles (grid) -->
          <g opacity="0.4">
            <circle cx="90" cy="60" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="115" cy="60" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="140" cy="60" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="165" cy="60" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="190" cy="60" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="215" cy="60" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="90" cy="85" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="115" cy="85" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="140" cy="85" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="165" cy="85" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="190" cy="85" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="215" cy="85" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="90" cy="110" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="115" cy="110" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="140" cy="110" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="165" cy="110" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="190" cy="110" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="215" cy="110" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="90" cy="135" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="115" cy="135" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="140" cy="135" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="165" cy="135" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="190" cy="135" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
            <circle cx="215" cy="135" r="10" fill="#4FC3F7" stroke="#1565A0" stroke-width="1"/>
          </g>

          <!-- Dimension arrows top -->
          <line x1="60" y1="183" x2="240" y2="183" stroke="#0B3D6B" stroke-width="1.5" marker-start="url(#arrowL)" marker-end="url(#arrowR)"/>
          <text x="130" y="198" font-family="Nunito" font-weight="700" font-size="12" fill="#0B3D6B" id="dimW">3.0 m</text>

          <line x1="252" y1="40" x2="252" y2="170" stroke="#0B3D6B" stroke-width="1.5" marker-start="url(#arrowU)" marker-end="url(#arrowD)"/>
          <text x="260" y="110" font-family="Nunito" font-weight="700" font-size="12" fill="#0B3D6B" id="dimH">2.5 m</text>

          <defs>
            <marker id="arrowR" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
              <path d="M0,0 L8,3 L0,6" fill="#0B3D6B"/>
            </marker>
            <marker id="arrowL" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
              <path d="M8,0 L0,3 L8,6" fill="#0B3D6B"/>
            </marker>
            <marker id="arrowU" markerWidth="6" markerHeight="8" refX="3" refY="0" orient="auto">
              <path d="M0,8 L3,0 L6,8" fill="#0B3D6B"/>
            </marker>
            <marker id="arrowD" markerWidth="6" markerHeight="8" refX="3" refY="8" orient="auto">
              <path d="M0,0 L3,8 L6,0" fill="#0B3D6B"/>
            </marker>
          </defs>

          <!-- Side view label -->
          <text x="30" y="235" font-family="Nunito, sans-serif" font-weight="800" font-size="14" fill="#0B3D6B">VISTA LATERALE</text>

          <!-- Water line -->
          <rect x="30" y="310" width="450" height="65" fill="url(#waterGrad)" rx="4"/>
          <text x="430" y="350" font-family="Nunito" font-size="10" fill="#1565A0" font-weight="700">MARE</text>

          <!-- Side view raft -->
          <rect x="80" y="280" width="280" height="12" rx="2" fill="#C49A6C" stroke="#5D3A1A" stroke-width="1.5"/>
          <text x="185" y="276" font-family="Nunito" font-size="10" fill="#8B5E3C" font-weight="700" text-anchor="middle">Compensato 18mm</text>

          <!-- Support beams -->
          <rect x="90" y="292" width="260" height="8" rx="1" fill="#8B5E3C" stroke="#5D3A1A" stroke-width="1"/>

          <!-- Jugs side view -->
          <ellipse cx="120" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>
          <ellipse cx="155" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>
          <ellipse cx="190" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>
          <ellipse cx="225" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>
          <ellipse cx="260" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>
          <ellipse cx="295" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>
          <ellipse cx="330" cy="318" rx="14" ry="16" fill="#B3E5FC" stroke="#1565A0" stroke-width="1.5" opacity="0.8"/>

          <!-- Ropes -->
          <line x1="106" y1="300" x2="106" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="140" y1="300" x2="140" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="174" y1="300" x2="174" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="208" y1="300" x2="208" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="242" y1="300" x2="242" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="276" y1="300" x2="276" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="310" y1="300" x2="310" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
          <line x1="344" y1="300" x2="344" y2="336" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>

          <!-- Water line marker -->
          <line x1="70" y1="310" x2="380" y2="310" stroke="#1565A0" stroke-width="1" stroke-dasharray="8,4"/>
          <text x="385" y="314" font-family="Nunito" font-size="9" fill="#1565A0" font-weight="600">linea d'acqua</text>

          <!-- Legend -->
          <g transform="translate(310, 240)">
            <rect x="0" y="0" width="160" height="95" rx="8" fill="white" stroke="#ddd" stroke-width="1"/>
            <text x="10" y="18" font-family="Nunito" font-size="10" font-weight="800" fill="#333">LEGENDA</text>
            <rect x="10" y="28" width="14" height="8" fill="#C49A6C" stroke="#5D3A1A" stroke-width="0.5" rx="1"/>
            <text x="30" y="36" font-family="Nunito" font-size="9" fill="#555">Compensato</text>
            <ellipse cx="17" cy="52" rx="7" ry="8" fill="#B3E5FC" stroke="#1565A0" stroke-width="1"/>
            <text x="30" y="56" font-family="Nunito" font-size="9" fill="#555">Boccione d'acqua</text>
            <line x1="10" y1="70" x2="24" y2="70" stroke="#D4A86A" stroke-width="2" stroke-dasharray="3,2"/>
            <text x="30" y="74" font-family="Nunito" font-size="9" fill="#555">Corde di fissaggio</text>
            <rect x="10" y="80" width="14" height="5" fill="#8B5E3C" rx="1"/>
            <text x="30" y="88" font-family="Nunito" font-size="9" fill="#555">Travetti supporto</text>
          </g>
        </svg>
      </div>
    </div>
  </div>

  <!-- MATERIALS -->
  <div class="card" style="animation-delay: 0.3s">
    <div class="card-title"><span class="icon">&#x1FAB5;</span> Lista Materiali</div>
    <p style="color:#666; margin-bottom:0.5rem; font-size:0.9rem;">Trascina le righe per riordinarle. Le voci "auto" si aggiornano con il calcolatore. Puoi modificare, eliminare o aggiungere qualsiasi riga.</p>
    <table class="materials-table" id="materialsTable">
      <thead>
        <tr>
          <th>Materiale</th>
          <th>Quantit&agrave;</th>
          <th>Note</th>
          <th style="width:80px; text-align:center;">Azioni</th>
        </tr>
      </thead>
      <tbody id="materialsBody">
        <!-- filled by JS -->
      </tbody>
    </table>
    <button class="btn-add-row" onclick="openMaterialEditor(-1)">+ Aggiungi materiale</button>
  </div>

  <!-- BUDGET ESTIMATE -->
  <div class="card" style="animation-delay: 0.35s">
    <div class="card-title"><span class="icon">&#x1F4B0;</span> Stima Budget</div>
    <p style="color:#666; margin-bottom:1rem; font-size:0.9rem;">Costi indicativi per i materiali. Puoi modificare i costi unitari nella lista materiali!</p>

    <table class="materials-table" id="budgetTable">
      <thead>
        <tr>
          <th>Materiale</th>
          <th>Costo stimato</th>
          <th>Dove trovarlo</th>
          <th style="width:80px; text-align:center;">Azioni</th>
        </tr>
      </thead>
      <tbody id="budgetBody">
        <!-- filled by JS -->
      </tbody>
    </table>
    <button class="btn-add-row" onclick="openBudgetEditor(-1)">+ Aggiungi voce di spesa</button>

    <div class="budget-total" id="budgetTotal"></div>
    <p class="budget-note">* Prezzi indicativi estate 2026. I boccioni possono essere gratuiti se recuperati da uffici, bar o distributori automatici.</p>

    <div class="info-box" style="margin-top:1rem">
      &#x1F4A1; <strong>Suggerimento:</strong> Chiedete a parenti, amici e colleghi di conservare i boccioni vuoti nelle settimane prima del progetto. Potrete risparmiare la voce di spesa principale!
    </div>
  </div>

  <!-- CONSTRUCTION STEPS -->
  <div class="card" style="animation-delay: 0.4s">
    <div class="card-title"><span class="icon">&#x1F528;</span> Fasi di Costruzione</div>

    <div class="step">
      <div class="step-num">1</div>
      <div class="step-content">
        <h3>Preparare i boccioni</h3>
        <p>Svuotare, lavare e asciugare tutti i boccioni. Verificare che i tappi siano ermetici. Avvitare bene e sigillare con silicone o nastro americano impermeabile. Lasciare asciugare 24h.</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">2</div>
      <div class="step-content">
        <h3>Costruire il telaio</h3>
        <p>Tagliare le tavole di compensato (18mm marino) nelle dimensioni calcolate. Creare una cornice con travetti in legno (listelli 5x5 cm) sotto il compensato, formando una griglia che accoglier&agrave; i boccioni. Fissare con viti inox.</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">3</div>
      <div class="step-content">
        <h3>Fissare i boccioni</h3>
        <p>Posizionare i boccioni nella griglia, ben distribuiti. Fissarli con corde nautiche passate attraverso fori nel compensato, creando una "rete" che li tenga in posizione. Ogni boccione va legato individualmente.</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">4</div>
      <div class="step-content">
        <h3>Impermeabilizzare</h3>
        <p>Trattare il compensato con vernice marina impermeabilizzante (almeno 2 mani). Prestare attenzione ai bordi e ai fori. Lasciare asciugare completamente prima del varo.</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">5</div>
      <div class="step-content">
        <h3>Aggiungere sicurezza e accessori</h3>
        <p>Installare corde perimetrali come maniglie. Aggiungere angolari anti-sfregamento. Preparare remi improvvisati (tavole o pagaie). Fissare un punto per legare una cima di sicurezza.</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">6</div>
      <div class="step-content">
        <h3>Test in acqua bassa!</h3>
        <p>Prima del grande viaggio, testare la zattera in acqua bassa con carico progressivo: prima 2 persone, poi 4, poi tutti. Verificare stabilit&agrave;, galleggiamento e tenuta dei boccioni.</p>
      </div>
    </div>
  </div>

  <!-- CHECKLIST -->
  <div class="card" style="animation-delay: 0.5s">
    <div class="card-title"><span class="icon">&#x2705;</span> Checklist Preparazione</div>
    <p style="color:#666; margin-bottom:0.5rem; font-size:0.9rem;" id="checklistDesc">Spunta le voci man mano che procedi! Puoi aggiungere, modificare o rimuovere voci.</p>
    <div id="syncStatus" style="display:none; margin-bottom:0.8rem; padding:0.5rem 1rem; border-radius:10px; font-size:0.8rem; font-weight:700;"></div>

    <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">0% completato</div>

    <div id="checklistContainer"></div>
    <button class="btn-add-row" onclick="openChecklistEditor(-1)">+ Aggiungi voce</button>
  </div>

  <!-- TIMELINE -->
  <div class="card" style="animation-delay: 0.55s">
    <div class="card-title"><span class="icon">&#x1F4C5;</span> Pianificazione &mdash; 3 Weekend</div>
    <p style="color:#666; margin-bottom:1rem; font-size:0.9rem;">Un piano realistico su 3 weekend per costruire la zattera senza fretta.</p>

    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-when">Weekend 1 &mdash; Sabato</div>
        <div class="timeline-what">Raccolta boccioni + acquisto materiali al brico/ferramenta</div>
        <div class="timeline-who">Tutti insieme</div>
      </div>
      <div class="timeline-item">
        <div class="timeline-when">Weekend 1 &mdash; Domenica</div>
        <div class="timeline-what">Lavare, asciugare e sigillare tutti i boccioni con silicone</div>
        <div class="timeline-who">Adulti + ragazzi</div>
      </div>
      <div class="timeline-item">
        <div class="timeline-when">Infrasettimanale</div>
        <div class="timeline-what">Asciugatura silicone (24-48h) &mdash; niente da fare!</div>
        <div class="timeline-who">&mdash;</div>
      </div>
      <div class="timeline-item">
        <div class="timeline-when">Weekend 2 &mdash; Sabato</div>
        <div class="timeline-what">Taglio compensato + costruzione telaio con travetti</div>
        <div class="timeline-who">Adulti (attrezzi elettrici)</div>
      </div>
      <div class="timeline-item">
        <div class="timeline-when">Weekend 2 &mdash; Domenica</div>
        <div class="timeline-what">Fissaggio boccioni alla griglia + 1a mano di vernice marina</div>
        <div class="timeline-who">Tutti insieme</div>
      </div>
      <div class="timeline-item">
        <div class="timeline-when">Infrasettimanale</div>
        <div class="timeline-what">Asciugatura + 2a mano di vernice</div>
        <div class="timeline-who">1 persona (15 min)</div>
      </div>
      <div class="timeline-item highlight">
        <div class="timeline-when">Weekend 3 &mdash; IL GRANDE GIORNO!</div>
        <div class="timeline-what">Accessori di sicurezza + TEST IN ACQUA + VARO!</div>
        <div class="timeline-who">TUTTI! &#x1F389;</div>
      </div>
    </div>

    <div class="info-box">
      &#x1F4A1; <strong>Meteo:</strong> Controllate le previsioni a inizio settimana per il weekend 3. Vento &lt; 10 nodi e mare calmo sono le condizioni ideali. In caso di maltempo, rimandate di una settimana &mdash; la zattera aspetta!
    </div>
  </div>

  <!-- SAFETY -->
  <div class="card" style="animation-delay: 0.6s">
    <div class="card-title"><span class="icon">&#x26A0;&#xFE0F;</span> Sicurezza in Mare</div>
    <p style="color:#666; margin-bottom:1rem; font-size:0.9rem;">Regole fondamentali per divertirsi in sicurezza.</p>

    <div class="safety-grid">
      <div class="safety-item">
        <h4>&#x1F9BA; Giubbotti salvagente</h4>
        <p>OBBLIGATORI per tutti, specialmente bambini. Un giubbotto per persona, omologato.</p>
      </div>
      <div class="safety-item">
        <h4>&#x1F4F1; Comunicazione</h4>
        <p>Portare cellulare in custodia impermeabile. Avvisare qualcuno a terra del percorso.</p>
      </div>
      <div class="safety-item">
        <h4>&#x1F9ED; Non allontanarsi troppo</h4>
        <p>Restare entro 300m dalla riva. Controllare le condizioni meteo prima di partire.</p>
      </div>
      <div class="safety-item">
        <h4>&#x2600;&#xFE0F; Protezione solare</h4>
        <p>Crema solare SPF 50+, cappelli, acqua potabile in abbondanza. Il sole in mare &egrave; implacabile.</p>
      </div>
      <div class="safety-item">
        <h4>&#x1FAA2; Cima di sicurezza</h4>
        <p>Legare una corda lunga (30m+) ancorata a riva o a un'imbarcazione di appoggio.</p>
      </div>
      <div class="safety-item">
        <h4>&#x1F3CA; Saper nuotare</h4>
        <p>Tutti i partecipanti devono saper nuotare. Bambini piccoli sempre con adulto dedicato.</p>
      </div>
    </div>
  </div>

  <div class="footer">
    Progetto Zattera Estate 2026 &mdash; Buon divertimento in famiglia! &#x1F30A;
  </div>

</div>

<!-- FLOATING SAVE BUTTON -->
<button class="fab-save" id="fabSave" onclick="saveAll()" title="Salva tutto su Firebase">
  &#x1F4BE;
  <span class="fab-label">SALVA TUTTO</span>
  <span class="unsaved-badge"></span>
</button>

<!-- TOAST NOTIFICATION -->
<div class="toast" id="toast"></div>

<!-- EDIT OVERLAY (modal for editing) -->
<div class="edit-overlay" id="editOverlay" onclick="if(event.target===this)closeEditor()">
  <div class="edit-panel" id="editPanel">
    <!-- dynamically filled -->
  </div>
</div>

<!-- NICKNAME MODAL -->
<div class="nick-overlay" id="nickOverlay">
  <div class="nick-panel">
    <h3>&#x1F44B; Come ti chiami?</h3>
    <p>Il tuo nome apparir&agrave; accanto alle modifiche che fai, cos&igrave; la famiglia sa chi ha cambiato cosa.</p>
    <input id="nickInput" placeholder="Es: Save, Mamma, Marco..." maxlength="20">
    <br>
    <button onclick="confirmNickname()">Conferma</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// =====================================================
// CONFIGURAZIONE FIREBASE
// =====================================================
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyB8XN_EE3FyeSTDJRF3pJxrYRwp1ZpIc1E",
  authDomain: "zattera-noi-e-wilson.firebaseapp.com",
  databaseURL: "https://zattera-noi-e-wilson-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zattera-noi-e-wilson",
  storageBucket: "zattera-noi-e-wilson.firebasestorage.app",
  messagingSenderId: "136898685704",
  appId: "1:136898685704:web:a97cbc5e94c27e749e1abd"
};

// =====================================================
// NICKNAME SYSTEM
// =====================================================
let currentNickname = '';

function loadNickname() {
  currentNickname = localStorage.getItem('zattera_nickname') || '';
  document.getElementById('nickDisplay').textContent = currentNickname || '...';
  if (!currentNickname) {
    setTimeout(function() { document.getElementById('nickOverlay').classList.add('open'); }, 600);
  }
}

function promptNickname() {
  document.getElementById('nickInput').value = currentNickname;
  document.getElementById('nickOverlay').classList.add('open');
  document.getElementById('nickInput').focus();
}

function confirmNickname() {
  const name = document.getElementById('nickInput').value.trim();
  if (!name) { document.getElementById('nickInput').style.borderColor = '#E53935'; return; }
  currentNickname = name;
  localStorage.setItem('zattera_nickname', name);
  document.getElementById('nickDisplay').textContent = name;
  document.getElementById('nickOverlay').classList.remove('open');
}

// Enter key on nickname input
document.getElementById('nickInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') confirmNickname();
});

const FIREBASE_ENABLED = FIREBASE_CONFIG.apiKey !== "" && FIREBASE_CONFIG.databaseURL !== "";

// =====================================================
// UTILITY: generate unique IDs
// =====================================================
function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

function stampItem(item) {
  item._by = currentNickname || '?';
  item._at = Date.now();
  return item;
}

function timeAgo(ts) {
  if (!ts) return '';
  const diff = Math.floor((Date.now() - ts) / 1000);
  if (diff < 60) return 'ora';
  if (diff < 3600) return Math.floor(diff / 60) + ' min fa';
  if (diff < 86400) return Math.floor(diff / 3600) + ' ore fa';
  return Math.floor(diff / 86400) + ' gg fa';
}

function modLabel(item) {
  if (!item._by) return '';
  return '<span class="mod-by">' + escHtml(item._by) + ', ' + timeAgo(item._at) + '</span>';
}

function modLabelBlock(item) {
  if (!item._by) return '';
  return '<span class="mod-by-row">' + escHtml(item._by) + ', ' + timeAgo(item._at) + '</span>';
}

// =====================================================
// PER-FIELD METADATA (calculator inputs)
// =====================================================
function fieldChanged(fieldName) {
  settingsMeta[fieldName] = { _by: currentNickname || '?', _at: Date.now() };
  updateFieldLabel(fieldName);
  calcola();
}

function updateFieldLabel(fieldName) {
  const el = document.getElementById('mod_' + fieldName);
  if (!el) return;
  const m = settingsMeta[fieldName];
  if (m && m._by) {
    el.textContent = m._by + ', ' + timeAgo(m._at);
  } else {
    el.textContent = '';
  }
}

function updateAllFieldLabels() {
  ['numPersone', 'pesoMedio', 'capienzaBoccione', 'margine'].forEach(updateFieldLabel);
}

// =====================================================
// FIREBASE + DATA
// =====================================================
let db = null;
let settingsRef = null;
let settingsMetaRef = null;
let materialsDataRef = null;
let budgetDataRef = null;
let checklistDataRef = null;
let ignoreSettings = false;
let ignoreSettingsMeta = false;
let ignoreMaterials = false;
let ignoreBudget = false;
let ignoreChecklist = false;

// Per-field metadata: { fieldName: { _by: 'Nick', _at: timestamp } }
let settingsMeta = {};

// Deleted IDs tracked per section (for merge)
let deletedMaterialIds = new Set();
let deletedBudgetIds = new Set();
let deletedChecklistIds = new Set();

// =====================================================
// DEFAULT DATA (with _id fields)
// =====================================================
const DEFAULT_CHECKLIST = [
  { _id: "chk_boccioni", text: "Raccogliere i boccioni (minimo calcolato)", cat: "Materiale", done: false },
  { _id: "chk_compensato", text: "Acquistare compensato marino 18mm", cat: "Materiale", done: false },
  { _id: "chk_travetti", text: "Acquistare travetti in legno 5x5 cm", cat: "Materiale", done: false },
  { _id: "chk_viti", text: "Procurare viti inox e bulloni", cat: "Materiale", done: false },
  { _id: "chk_corda", text: "Comprare corda nautica (30m+)", cat: "Materiale", done: false },
  { _id: "chk_silicone", text: "Silicone o nastro americano impermeabile", cat: "Materiale", done: false },
  { _id: "chk_vernice", text: "Vernice marina impermeabilizzante", cat: "Materiale", done: false },
  { _id: "chk_giubbotti", text: "Giubbotti salvagente per tutti", cat: "Sicurezza", done: false },
  { _id: "chk_custodia", text: "Custodia impermeabile per cellulare", cat: "Sicurezza", done: false },
  { _id: "chk_crema", text: "Crema solare SPF 50+", cat: "Sicurezza", done: false },
  { _id: "chk_acqua", text: "Acqua potabile e snack", cat: "Sicurezza", done: false },
  { _id: "chk_remi", text: "Remi o pagaie", cat: "Attrezzi", done: false },
  { _id: "chk_trapano", text: "Trapano con punte per legno", cat: "Attrezzi", done: false },
  { _id: "chk_seghetto", text: "Seghetto circolare o a mano", cat: "Attrezzi", done: false },
  { _id: "chk_metro", text: "Metro, matita, squadra", cat: "Attrezzi", done: false },
  { _id: "chk_tenuta", text: "Verificare tenuta ermetica boccioni", cat: "Test", done: false },
  { _id: "chk_trattare", text: "Trattare compensato (2 mani vernice)", cat: "Costruzione", done: false },
  { _id: "chk_assemblare", text: "Assemblare telaio + boccioni", cat: "Costruzione", done: false },
  { _id: "chk_testacqua", text: "Test in acqua bassa (carico progressivo)", cat: "Test", done: false },
  { _id: "chk_meteo", text: "Controllare meteo il giorno del varo", cat: "Varo", done: false },
  { _id: "chk_avvisare", text: "Avvisare qualcuno del percorso", cat: "Varo", done: false },
  { _id: "chk_divertirsi", text: "DIVERTIRSI!", cat: "Varo", done: false }
];

const CATEGORIES = ["Materiale", "Sicurezza", "Attrezzi", "Test", "Costruzione", "Varo", "Altro"];

// =====================================================
// DATA ARRAYS (unified: auto + custom, all with _id)
// =====================================================
let checklistData = JSON.parse(JSON.stringify(DEFAULT_CHECKLIST));
let materialsData = [];
let budgetData = [];
let materialsInitialized = false;
let budgetInitialized = false;

// =====================================================
// FIREBASE INIT — listeners receive remote changes
// =====================================================
if (FIREBASE_ENABLED) {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    settingsRef = db.ref('zattera/v2/settings');
    settingsMetaRef = db.ref('zattera/v2/settingsMeta');
    materialsDataRef = db.ref('zattera/v2/materials');
    budgetDataRef = db.ref('zattera/v2/budget');
    checklistDataRef = db.ref('zattera/v2/checklist');

    checklistDataRef.on('value', (snap) => {
      if (ignoreChecklist) return;
      const d = snap.val();
      if (d) {
        checklistData = Array.isArray(d) ? d : Object.values(d);
        renderChecklist(); updateProgress();
      }
      showSyncStatus('online');
    });

    materialsDataRef.on('value', (snap) => {
      if (ignoreMaterials) return;
      const d = snap.val();
      if (d) {
        materialsData = Array.isArray(d) ? d : Object.values(d);
        materialsInitialized = true;
        renderMaterials();
      }
    });

    budgetDataRef.on('value', (snap) => {
      if (ignoreBudget) return;
      const d = snap.val();
      if (d) {
        budgetData = Array.isArray(d) ? d : Object.values(d);
        budgetInitialized = true;
        renderBudget();
      }
    });

    settingsRef.on('value', (snap) => {
      if (ignoreSettings) return;
      const s = snap.val();
      if (s) {
        if (s.numPersone) document.getElementById('numPersone').value = s.numPersone;
        if (s.pesoMedio) document.getElementById('pesoMedio').value = s.pesoMedio;
        if (s.capienzaBoccione) document.getElementById('capienzaBoccione').value = s.capienzaBoccione;
        if (s.margine) document.getElementById('margine').value = s.margine;
        calcola(true);
      }
    });

    settingsMetaRef.on('value', (snap) => {
      if (ignoreSettingsMeta) return;
      const d = snap.val();
      if (d && typeof d === 'object') {
        settingsMeta = d;
        updateAllFieldLabels();
      }
    });

    db.ref('.info/connected').on('value', (snap) => {
      showSyncStatus(snap.val() ? 'online' : 'offline');
    });
  } catch (e) {
    console.warn('Firebase init failed:', e);
    showSyncStatus('error');
  }
}

// =====================================================
// MERGE SAVE — per section, preserves other users' items
// =====================================================
function toArr(val) {
  if (!val) return [];
  return Array.isArray(val) ? val : Object.values(val);
}

async function mergeSave(ref, localItems, deletedIds, ignoreFlag) {
  if (!FIREBASE_ENABLED || !ref) return localItems;

  // Read current remote state
  const snap = await ref.once('value');
  const remote = toArr(snap.val());

  // Build set of local IDs
  const localIds = new Set(localItems.map(i => i._id).filter(Boolean));

  // Start with local items (user's order)
  const merged = localItems.map(item => Object.assign({}, item));

  // Append remote-only items (added by others, not deleted by us)
  remote.forEach(ri => {
    if (ri._id && !localIds.has(ri._id) && !deletedIds.has(ri._id)) {
      merged.push(ri);
    }
  });

  // Write merged result
  if (ignoreFlag === 'checklist') ignoreChecklist = true;
  else if (ignoreFlag === 'materials') ignoreMaterials = true;
  else if (ignoreFlag === 'budget') ignoreBudget = true;

  await ref.set(merged);

  setTimeout(() => {
    if (ignoreFlag === 'checklist') ignoreChecklist = false;
    else if (ignoreFlag === 'materials') ignoreMaterials = false;
    else if (ignoreFlag === 'budget') ignoreBudget = false;
  }, 500);

  deletedIds.clear();
  return merged;
}

// =====================================================
// UNSAVED CHANGES TRACKING
// =====================================================
let hasUnsavedChanges = false;

function markUnsaved() {
  if (!hasUnsavedChanges) {
    hasUnsavedChanges = true;
    document.getElementById('fabSave').classList.add('unsaved');
  }
}

function markSaved() {
  hasUnsavedChanges = false;
  document.getElementById('fabSave').classList.remove('unsaved');
}

// =====================================================
// SAVE ALL — merges per section, only on button press
// =====================================================
async function saveAll() {
  const fab = document.getElementById('fabSave');
  fab.style.pointerEvents = 'none';
  fab.style.opacity = '0.6';
  showToast('Salvataggio in corso...', '');

  try {
    if (FIREBASE_ENABLED) {
      // Save settings (simple overwrite)
      ignoreSettings = true;
      await settingsRef.set({
        numPersone: parseInt(document.getElementById('numPersone').value) || 8,
        pesoMedio: parseInt(document.getElementById('pesoMedio').value) || 75,
        capienzaBoccione: parseInt(document.getElementById('capienzaBoccione').value) || 18,
        margine: parseFloat(document.getElementById('margine').value) || 1.3,
        _by: currentNickname, _at: Date.now()
      });
      setTimeout(() => { ignoreSettings = false; }, 500);

      // Save per-field metadata
      ignoreSettingsMeta = true;
      await settingsMetaRef.set(settingsMeta);
      setTimeout(() => { ignoreSettingsMeta = false; }, 500);

      // Merge-save each section
      checklistData = await mergeSave(checklistDataRef, checklistData, deletedChecklistIds, 'checklist');
      materialsData = await mergeSave(materialsDataRef, materialsData, deletedMaterialIds, 'materials');
      budgetData = await mergeSave(budgetDataRef, budgetData, deletedBudgetIds, 'budget');

      renderChecklist(); updateProgress();
      renderMaterials();
      renderBudget();
    } else {
      // localStorage fallback
      localStorage.setItem('zattera_checklistData', JSON.stringify(checklistData));
      localStorage.setItem('zattera_materialsData', JSON.stringify(materialsData));
      localStorage.setItem('zattera_budgetData', JSON.stringify(budgetData));
      localStorage.setItem('zattera_settingsMeta', JSON.stringify(settingsMeta));
    }

    markSaved();
    showToast('Tutto salvato!', 'success');
  } catch (e) {
    console.error('Save error:', e);
    showToast('Errore nel salvataggio!', 'error');
  }

  fab.style.pointerEvents = '';
  fab.style.opacity = '';
}

// =====================================================
// TOAST
// =====================================================
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || '');
  t.classList.add('show');
  setTimeout(() => { t.classList.remove('show'); }, 2500);
}

// =====================================================
// SYNC STATUS
// =====================================================
function showSyncStatus(status) {
  const el = document.getElementById('syncStatus');
  const desc = document.getElementById('checklistDesc');
  if (!FIREBASE_ENABLED) {
    el.style.display = 'none';
    desc.textContent = 'Spunta le voci man mano che procedi! Puoi aggiungere, modificare o rimuovere voci. Progressi salvati localmente.';
    return;
  }
  el.style.display = 'block';
  if (status === 'online') {
    el.style.background = '#E8F5E9';
    el.style.color = '#2E7D32';
    el.innerHTML = '&#x1F7E2; Sincronizzato — Le modifiche sono condivise con tutta la famiglia in tempo reale';
    desc.textContent = 'Spunta le voci man mano che procedi! Puoi aggiungere, modificare o rimuovere voci.';
  } else if (status === 'offline') {
    el.style.background = '#FFF3E0';
    el.style.color = '#E65100';
    el.innerHTML = '&#x1F7E0; Offline — Le modifiche verranno sincronizzate appena torni online';
  } else {
    el.style.background = '#FFEBEE';
    el.style.color = '#C62828';
    el.innerHTML = '&#x1F534; Firebase non configurato — Usando salvataggio locale. Vedi guida-setup.html';
  }
}

// =====================================================
// EDITOR (MODAL)
// =====================================================
function openEditor(html) {
  document.getElementById('editPanel').innerHTML = html;
  document.getElementById('editOverlay').classList.add('open');
}

function closeEditor() {
  document.getElementById('editOverlay').classList.remove('open');
}

// =====================================================
// MATERIALS (UNIFIED — all draggable)
// =====================================================
function renderMaterials() {
  const tbody = document.getElementById('materialsBody');
  let html = '';
  materialsData.forEach((m, i) => {
    const isAuto = m.auto;
    html += '<tr' + (isAuto ? '' : ' style="background:#f0fff0;"') + ' data-idx="' + i + '" data-list="materials">' +
      '<td><span class="drag-handle" title="Trascina per riordinare">&#x2630;</span> ' + escHtml(m.name) +
        (isAuto ? ' <span style="font-size:0.65rem;color:#aaa;background:#f0f0f0;padding:1px 5px;border-radius:4px;">auto</span>' : '') +
        modLabelBlock(m) + '</td>' +
      '<td><strong>' + escHtml(m.qty) + '</strong></td>' +
      '<td>' + escHtml(m.note || '') + '</td>' +
      '<td style="text-align:center"><div class="row-actions" style="justify-content:center">' +
        '<button class="btn-icon btn-edit" onclick="openMaterialEditor(' + i + ')" title="Modifica">&#x270F;&#xFE0F;</button>' +
        '<button class="btn-icon btn-delete" onclick="deleteMaterial(' + i + ')" title="Elimina">&#x1F5D1;&#xFE0F;</button>' +
      '</div></td>' +
    '</tr>';
  });
  tbody.innerHTML = html;
  setTimeout(function() { setupTableDrag('materialsBody', 'materials'); }, 0);
}

function openMaterialEditor(idx) {
  const isNew = idx === -1;
  const m = isNew ? { name: '', qty: '', note: '' } : materialsData[idx];
  openEditor(
    '<h3>' + (isNew ? 'Aggiungi Materiale' : 'Modifica Materiale') + '</h3>' +
    '<div class="form-group"><label>Materiale</label><input id="edMatName" value="' + escAttr(m.name) + '" placeholder="Es: Vernice extra"></div>' +
    '<div class="form-group"><label>Quantit&agrave;</label><input id="edMatQty" value="' + escAttr(m.qty) + '" placeholder="Es: 3 barattoli"></div>' +
    '<div class="form-group"><label>Note</label><input id="edMatNote" value="' + escAttr(m.note || '') + '" placeholder="Es: Per rinforzo"></div>' +
    '<div class="btn-row">' +
      '<button class="btn-confirm secondary" onclick="closeEditor()">Annulla</button>' +
      '<button class="btn-confirm primary" onclick="saveMaterialEdit(' + idx + ')">Salva</button>' +
    '</div>'
  );
  document.getElementById('edMatName').focus();
}

function saveMaterialEdit(idx) {
  const name = document.getElementById('edMatName').value.trim();
  const qty = document.getElementById('edMatQty').value.trim();
  const note = document.getElementById('edMatNote').value.trim();
  if (!name) { showToast('Inserisci il nome del materiale', 'error'); return; }
  if (idx === -1) {
    materialsData.push(stampItem({ _id: genId(), name, qty, note, auto: false }));
  } else {
    materialsData[idx].name = name;
    materialsData[idx].qty = qty;
    materialsData[idx].note = note;
    if (materialsData[idx].auto) { materialsData[idx].auto = false; delete materialsData[idx].key; }
    stampItem(materialsData[idx]);
  }
  markUnsaved();
  renderMaterials();
  closeEditor();
  showToast(idx === -1 ? 'Materiale aggiunto!' : 'Materiale modificato!', 'success');
}

function deleteMaterial(idx) {
  if (!confirm('Eliminare "' + materialsData[idx].name + '"?')) return;
  if (materialsData[idx]._id) deletedMaterialIds.add(materialsData[idx]._id);
  materialsData.splice(idx, 1);
  markUnsaved();
  renderMaterials();
  showToast('Materiale eliminato', 'success');
}

// =====================================================
// BUDGET (UNIFIED — all draggable)
// =====================================================
function renderBudget() {
  const budgetBody = document.getElementById('budgetBody');
  let totalCost = 0;
  let html = '';

  budgetData.forEach((item, i) => {
    const isAuto = item.auto;
    const cost = parseFloat(item.cost) || 0;
    const qty = parseInt(item.qty) || 1;
    const subtotal = cost * qty;
    totalCost += subtotal;
    html += '<tr' + (isAuto ? '' : ' style="background:#f0fff0;"') + ' data-idx="' + i + '" data-list="budget">' +
      '<td><span class="drag-handle" title="Trascina per riordinare">&#x2630;</span> ' + escHtml(item.name) + (qty > 1 ? ' (x' + qty + ')' : '') +
        (isAuto ? ' <span style="font-size:0.65rem;color:#aaa;background:#f0f0f0;padding:1px 5px;border-radius:4px;">auto</span>' : '') +
        modLabelBlock(item) + '</td>' +
      '<td><strong>' + (subtotal === 0 ? 'GRATIS*' : '~' + subtotal.toFixed(0) + ' \u20AC') + '</strong></td>' +
      '<td>' + escHtml(item.where || '') + '</td>' +
      '<td style="text-align:center"><div class="row-actions" style="justify-content:center">' +
        '<button class="btn-icon btn-edit" onclick="openBudgetEditor(' + i + ')" title="Modifica">&#x270F;&#xFE0F;</button>' +
        '<button class="btn-icon btn-delete" onclick="deleteBudgetItem(' + i + ')" title="Elimina">&#x1F5D1;&#xFE0F;</button>' +
      '</div></td>' +
    '</tr>';
  });

  budgetBody.innerHTML = html;

  document.getElementById('budgetTotal').innerHTML =
    '<div class="total-label">BUDGET TOTALE STIMATO</div>' +
    '<div class="total-number">~' + totalCost + ' \u20AC</div>' +
    '<div class="total-label" style="margin-top:0.3rem; opacity:0.7">Esclusi attrezzi (trapano, seghetto) che probabilmente avete gi&agrave;</div>';
  setTimeout(function() { setupTableDrag('budgetBody', 'budget'); }, 0);
}

function openBudgetEditor(idx) {
  const isNew = idx === -1;
  const b = isNew ? { name: '', cost: '', qty: 1, where: '' } : budgetData[idx];
  openEditor(
    '<h3>' + (isNew ? 'Aggiungi Voce di Spesa' : 'Modifica Voce di Spesa') + '</h3>' +
    '<div class="form-group"><label>Descrizione</label><input id="edBudName" value="' + escAttr(b.name) + '" placeholder="Es: Pagaia extra"></div>' +
    '<div class="form-group"><label>Costo unitario (&euro;)</label><input id="edBudCost" type="number" step="0.5" value="' + (b.cost || '') + '" placeholder="0 = gratis"></div>' +
    '<div class="form-group"><label>Quantit&agrave;</label><input id="edBudQty" type="number" min="1" value="' + (b.qty || 1) + '"></div>' +
    '<div class="form-group"><label>Dove trovarlo</label><input id="edBudWhere" value="' + escAttr(b.where || '') + '" placeholder="Es: Amazon, Decathlon"></div>' +
    '<div class="btn-row">' +
      '<button class="btn-confirm secondary" onclick="closeEditor()">Annulla</button>' +
      '<button class="btn-confirm primary" onclick="saveBudgetEdit(' + idx + ')">Salva</button>' +
    '</div>'
  );
  document.getElementById('edBudName').focus();
}

function saveBudgetEdit(idx) {
  const name = document.getElementById('edBudName').value.trim();
  const cost = parseFloat(document.getElementById('edBudCost').value) || 0;
  const qty = parseInt(document.getElementById('edBudQty').value) || 1;
  const where = document.getElementById('edBudWhere').value.trim();
  if (!name) { showToast('Inserisci la descrizione', 'error'); return; }
  if (idx === -1) {
    budgetData.push(stampItem({ _id: genId(), name, cost, qty, where, auto: false }));
  } else {
    budgetData[idx].name = name;
    budgetData[idx].cost = cost;
    budgetData[idx].qty = qty;
    budgetData[idx].where = where;
    if (budgetData[idx].auto) { budgetData[idx].auto = false; delete budgetData[idx].key; }
    stampItem(budgetData[idx]);
  }
  markUnsaved();
  renderBudget();
  closeEditor();
  showToast(idx === -1 ? 'Voce aggiunta!' : 'Voce modificata!', 'success');
}

function deleteBudgetItem(idx) {
  if (!confirm('Eliminare "' + budgetData[idx].name + '"?')) return;
  if (budgetData[idx]._id) deletedBudgetIds.add(budgetData[idx]._id);
  budgetData.splice(idx, 1);
  markUnsaved();
  renderBudget();
  showToast('Voce eliminata', 'success');
}

// =====================================================
// CHECKLIST (EDITABLE)
// =====================================================
function getCatClass(cat) {
  if (['Sicurezza'].includes(cat)) return 'safety';
  if (['Attrezzi'].includes(cat)) return 'tool';
  return '';
}

function renderChecklist() {
  const container = document.getElementById('checklistContainer');
  container.innerHTML = '';
  checklistData.forEach((item, i) => {
    const div = document.createElement('div');
    div.className = 'checklist-item' + (item.done ? ' done' : '');
    div.setAttribute('data-idx', i);
    div.setAttribute('data-list', 'checklist');
    const catClass = getCatClass(item.cat);
    div.innerHTML =
      '<span class="drag-handle" title="Trascina per riordinare">&#x2630;</span>' +
      '<input type="checkbox" ' + (item.done ? 'checked' : '') + ' onchange="toggleCheck(' + i + ', this)">' +
      '<span class="item-text">' + escHtml(item.text) + modLabel(item) + '</span>' +
      '<span class="item-category ' + catClass + '">' + escHtml(item.cat) + '</span>' +
      '<div class="row-actions">' +
        '<button class="btn-icon btn-edit" onclick="event.stopPropagation();openChecklistEditor(' + i + ')" title="Modifica">&#x270F;&#xFE0F;</button>' +
        '<button class="btn-icon btn-delete" onclick="event.stopPropagation();deleteChecklistItem(' + i + ')" title="Elimina">&#x1F5D1;&#xFE0F;</button>' +
      '</div>';
    // Attach touch drag events to handle
    const handle = div.querySelector('.drag-handle');
    handle.addEventListener('touchstart', function(e) { touchDragStart(e, div, 'checklist'); }, {passive: false});
    container.appendChild(div);
  });
  // Setup HTML5 drag on handles
  setupDragHandles(container, 'checklist');
}

function toggleCheck(i, el) {
  checklistData[i].done = el.checked;
  stampItem(checklistData[i]);
  el.closest('.checklist-item').classList.toggle('done', el.checked);
  updateProgress();
  markUnsaved();
}

function updateProgress() {
  let done = checklistData.filter(item => item.done).length;
  const total = checklistData.length;
  const pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = pct + '% completato (' + done + '/' + total + ')';
}

function openChecklistEditor(idx) {
  const isNew = idx === -1;
  const item = isNew ? { text: '', cat: 'Altro' } : checklistData[idx];
  let catOptions = CATEGORIES.map(c =>
    '<option value="' + c + '"' + (c === item.cat ? ' selected' : '') + '>' + c + '</option>'
  ).join('');
  openEditor(
    '<h3>' + (isNew ? 'Aggiungi Voce Checklist' : 'Modifica Voce Checklist') + '</h3>' +
    '<div class="form-group"><label>Descrizione</label><input id="edChkText" value="' + escAttr(item.text) + '" placeholder="Es: Comprare colla epossidica"></div>' +
    '<div class="form-group"><label>Categoria</label><select id="edChkCat">' + catOptions + '</select></div>' +
    '<div class="btn-row">' +
      '<button class="btn-confirm secondary" onclick="closeEditor()">Annulla</button>' +
      '<button class="btn-confirm primary" onclick="saveChecklistEdit(' + idx + ')">Salva</button>' +
    '</div>'
  );
  document.getElementById('edChkText').focus();
}

function saveChecklistEdit(idx) {
  const text = document.getElementById('edChkText').value.trim();
  const cat = document.getElementById('edChkCat').value;
  if (!text) { showToast('Inserisci la descrizione', 'error'); return; }
  if (idx === -1) {
    checklistData.push(stampItem({ _id: genId(), text, cat, done: false }));
  } else {
    checklistData[idx].text = text;
    checklistData[idx].cat = cat;
    stampItem(checklistData[idx]);
  }
  markUnsaved();
  renderChecklist();
  updateProgress();
  closeEditor();
  showToast(idx === -1 ? 'Voce aggiunta!' : 'Voce modificata!', 'success');
}

function deleteChecklistItem(idx) {
  if (!confirm('Eliminare "' + checklistData[idx].text + '"?')) return;
  if (checklistData[idx]._id) deletedChecklistIds.add(checklistData[idx]._id);
  checklistData.splice(idx, 1);
  markUnsaved();
  renderChecklist();
  updateProgress();
  showToast('Voce eliminata', 'success');
}

// =====================================================
// CALCULATOR
// =====================================================
function calcola(fromFirebase) {
  if (!fromFirebase) markUnsaved();
  const numPersone = parseInt(document.getElementById('numPersone').value) || 8;
  const pesoMedio = parseInt(document.getElementById('pesoMedio').value) || 75;
  const capienza = parseInt(document.getElementById('capienzaBoccione').value) || 18;
  const margine = parseFloat(document.getElementById('margine').value) || 1.3;

  const pesoTotalePersone = numPersone * pesoMedio;
  const pesoStruttura = 80 + (numPersone > 6 ? 40 : 0);
  const pesoTotale = pesoTotalePersone + pesoStruttura;
  const spintaNecessaria = pesoTotale * margine;
  const numBoccioni = Math.ceil(spintaNecessaria / capienza);

  // Calculate raft dimensions
  const areaPerPersona = 0.7;
  const areaMinima = numPersone * areaPerPersona;
  let larghezza, lunghezza;
  if (numPersone <= 4) { larghezza = 2.0; lunghezza = Math.max(2.0, Math.ceil(areaMinima / 2.0 * 10) / 10); }
  else if (numPersone <= 8) { larghezza = 2.5; lunghezza = Math.max(2.5, Math.ceil(areaMinima / 2.5 * 10) / 10); }
  else { larghezza = 3.0; lunghezza = Math.max(3.0, Math.ceil(areaMinima / 3.0 * 10) / 10); }

  const jugDiam = capienza >= 15 ? 0.30 : 0.22;
  const colsMax = Math.floor(lunghezza / jugDiam);
  const rowsMax = Math.floor(larghezza / jugDiam);
  if (colsMax * rowsMax < numBoccioni) {
    lunghezza = Math.ceil(numBoccioni / rowsMax) * jugDiam + 0.2;
    lunghezza = Math.ceil(lunghezza * 10) / 10;
  }

  const numCompensato = Math.ceil((lunghezza * larghezza) / (1.22 * 2.44));

  document.getElementById('risultati').innerHTML =
    '<div class="result-item"><div class="number">' + numBoccioni + '</div><div class="label">Boccioni da ' + capienza + 'L</div></div>' +
    '<div class="result-item"><div class="number">' + pesoTotale + ' kg</div><div class="label">Peso totale</div></div>' +
    '<div class="result-item"><div class="number">' + lunghezza + ' &times; ' + larghezza + ' m</div><div class="label">Dimensioni zattera</div></div>' +
    '<div class="result-item"><div class="number">' + numCompensato + '</div><div class="label">Fogli compensato</div></div>';

  document.getElementById('dimW').textContent = lunghezza.toFixed(1) + ' m';
  document.getElementById('dimH').textContent = larghezza.toFixed(1) + ' m';

  // Fresh auto materials (used for init and for updating quantities)
  const freshMaterials = [
    { _id: 'mat_boccioni', name: 'Boccioni acqua vuoti (' + capienza + 'L)', qty: numBoccioni + ' pezzi', note: 'Ben chiusi e sigillati', auto: true, key: 'boccioni' },
    { _id: 'mat_compensato', name: 'Compensato marino 18mm (122x244 cm)', qty: numCompensato + ' fogli', note: 'Trattato con vernice marina', auto: true, key: 'compensato' },
    { _id: 'mat_travetti', name: 'Travetti legno 5x5 cm', qty: '~' + Math.ceil((lunghezza + larghezza) * 3) + ' m lineari', note: 'Per telaio e griglia supporto', auto: true, key: 'travetti' },
    { _id: 'mat_viti', name: 'Viti inox 4x50mm', qty: '~' + (numCompensato * 30) + ' pezzi', note: 'Resistenti alla salsedine', auto: true, key: 'viti' },
    { _id: 'mat_corda', name: 'Corda nautica (8-10mm)', qty: '~' + Math.ceil(numBoccioni * 0.8) + ' m', note: 'Per fissaggio boccioni + perimetrale', auto: true, key: 'corda' },
    { _id: 'mat_silicone', name: 'Silicone nautico', qty: '2 tubetti', note: 'Per sigillare tappi boccioni', auto: true, key: 'silicone' },
    { _id: 'mat_vernice', name: 'Vernice marina impermeabilizzante', qty: '2 barattoli', note: '2 mani su tutto il legno', auto: true, key: 'vernice' },
    { _id: 'mat_nastro', name: 'Nastro americano impermeabile', qty: '2 rotoli', note: 'Rinforzo e riparazioni', auto: true, key: 'nastro' },
    { _id: 'mat_giubbotti', name: 'Giubbotti salvagente', qty: numPersone + ' pezzi', note: 'Omologati, uno per persona!', auto: true, key: 'giubbotti' }
  ];

  const freshBudget = [
    { _id: 'bud_boccioni', name: 'Boccioni acqua ' + capienza + 'L', cost: 0, qty: numBoccioni, where: 'Uffici, bar, distributori', auto: true, key: 'boccioni' },
    { _id: 'bud_compensato', name: 'Compensato marino 18mm', cost: 35, qty: numCompensato, where: 'Brico, falegnameria', auto: true, key: 'compensato' },
    { _id: 'bud_travetti', name: 'Travetti legno 5x5 cm', cost: 3, qty: Math.ceil((lunghezza + larghezza) * 3), where: 'Brico, falegnameria', auto: true, key: 'travetti' },
    { _id: 'bud_viti', name: 'Viti inox 4x50mm (conf. 100)', cost: 12, qty: Math.ceil(numCompensato * 30 / 100), where: 'Ferramenta', auto: true, key: 'viti' },
    { _id: 'bud_corda', name: 'Corda nautica 8-10mm (al metro)', cost: 1.5, qty: Math.ceil(numBoccioni * 0.8), where: 'Negozio nautico, online', auto: true, key: 'corda' },
    { _id: 'bud_silicone', name: 'Silicone nautico', cost: 8, qty: 2, where: 'Brico, ferramenta', auto: true, key: 'silicone' },
    { _id: 'bud_vernice', name: 'Vernice marina (0.75L)', cost: 18, qty: 2, where: 'Brico, negozio nautico', auto: true, key: 'vernice' },
    { _id: 'bud_nastro', name: 'Nastro americano impermeabile', cost: 5, qty: 2, where: 'Brico, ferramenta', auto: true, key: 'nastro' },
    { _id: 'bud_giubbotti', name: 'Giubbotti salvagente', cost: 15, qty: numPersone, where: 'Decathlon, negozio nautico', auto: true, key: 'giubbotti' },
    { _id: 'bud_custodia', name: 'Custodia impermeabile cell.', cost: 8, qty: 2, where: 'Online, Decathlon', auto: true, key: 'custodia' }
  ];

  // Initialize or update materials
  if (!materialsInitialized || materialsData.length === 0) {
    materialsData = freshMaterials;
    materialsInitialized = true;
  } else {
    // Update auto items in place (keep user's order)
    freshMaterials.forEach(fresh => {
      const existing = materialsData.find(m => m.auto && m.key === fresh.key);
      if (existing) {
        existing.name = fresh.name;
        existing.qty = fresh.qty;
        existing.note = fresh.note;
      }
      // If user deleted an auto item, don't re-add it
    });
  }
  renderMaterials();

  // Initialize or update budget
  if (!budgetInitialized || budgetData.length === 0) {
    budgetData = freshBudget;
    budgetInitialized = true;
  } else {
    freshBudget.forEach(fresh => {
      const existing = budgetData.find(b => b.auto && b.key === fresh.key);
      if (existing) {
        existing.name = fresh.name;
        existing.qty = fresh.qty;
        existing.cost = fresh.cost;
        existing.where = fresh.where;
      }
    });
  }
  renderBudget();

  // Warning
  const warn = document.getElementById('warningBox');
  if (numBoccioni > 80) {
    warn.style.display = 'block';
    warn.innerHTML = '&#x26A0;&#xFE0F; <strong>Attenzione:</strong> servono molti boccioni (' + numBoccioni + '). Valuta di usare boccioni pi&ugrave; grandi o ridurre il numero di persone.';
  } else {
    warn.style.display = 'none';
  }
}

// =====================================================
// DRAG AND DROP
// =====================================================
let dragSrcIdx = null;
let dragListType = null;

function getListData(type) {
  if (type === 'checklist') return checklistData;
  if (type === 'materials') return materialsData;
  if (type === 'budget') return budgetData;
  return [];
}

function rerenderList(type) {
  if (type === 'checklist') { renderChecklist(); updateProgress(); }
  else if (type === 'materials') renderMaterials();
  else if (type === 'budget') renderBudget();
}

function moveItem(list, fromIdx, toIdx) {
  if (fromIdx === toIdx) return;
  const item = list.splice(fromIdx, 1)[0];
  list.splice(toIdx, 0, item);
}

// HTML5 Drag and Drop (desktop)
function setupDragHandles(container, listType) {
  const items = container.querySelectorAll('[data-list="' + listType + '"]');
  items.forEach(el => {
    const handle = el.querySelector('.drag-handle');
    if (!handle) return;

    handle.addEventListener('mousedown', function() {
      el.setAttribute('draggable', 'true');
    });
    el.addEventListener('dragstart', function(e) {
      dragSrcIdx = parseInt(el.getAttribute('data-idx'));
      dragListType = listType;
      el.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', dragSrcIdx);
    });
    el.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      // Clear all drag-over
      items.forEach(x => x.classList.remove('drag-over'));
      if (parseInt(el.getAttribute('data-idx')) !== dragSrcIdx) {
        el.classList.add('drag-over');
      }
    });
    el.addEventListener('dragleave', function() {
      el.classList.remove('drag-over');
    });
    el.addEventListener('drop', function(e) {
      e.preventDefault();
      el.classList.remove('drag-over');
      const toIdx = parseInt(el.getAttribute('data-idx'));
      if (dragSrcIdx !== null && dragSrcIdx !== toIdx && dragListType === listType) {
        const list = getListData(listType);
        moveItem(list, dragSrcIdx, toIdx);
        markUnsaved();
        rerenderList(listType);
        showToast('Ordine aggiornato!', 'success');
      }
    });
    el.addEventListener('dragend', function() {
      el.classList.remove('dragging');
      el.setAttribute('draggable', 'false');
      items.forEach(x => x.classList.remove('drag-over'));
      dragSrcIdx = null;
      dragListType = null;
    });
  });
}

// Touch Drag and Drop (mobile)
let touchDragEl = null;
let touchGhost = null;
let touchListType = null;
let touchStartIdx = null;
let touchCurrentTarget = null;

function touchDragStart(e, el, listType) {
  e.preventDefault();
  touchDragEl = el;
  touchListType = listType;
  touchStartIdx = parseInt(el.getAttribute('data-idx'));
  el.classList.add('dragging');

  // Create ghost
  touchGhost = document.createElement('div');
  touchGhost.className = 'drag-ghost';
  const textEl = el.querySelector('.item-text') || el.querySelector('td');
  touchGhost.textContent = textEl ? textEl.textContent.trim().substring(0, 40) : '...';
  document.body.appendChild(touchGhost);

  const touch = e.touches[0];
  touchGhost.style.left = (touch.clientX + 10) + 'px';
  touchGhost.style.top = (touch.clientY - 20) + 'px';

  document.addEventListener('touchmove', touchDragMove, {passive: false});
  document.addEventListener('touchend', touchDragEnd);
}

function touchDragMove(e) {
  e.preventDefault();
  const touch = e.touches[0];
  if (touchGhost) {
    touchGhost.style.left = (touch.clientX + 10) + 'px';
    touchGhost.style.top = (touch.clientY - 20) + 'px';
  }

  // Find element under finger
  if (touchGhost) touchGhost.style.display = 'none';
  const elUnder = document.elementFromPoint(touch.clientX, touch.clientY);
  if (touchGhost) touchGhost.style.display = '';

  // Find closest list item
  const container = touchDragEl.parentElement;
  const items = container.querySelectorAll('[data-list="' + touchListType + '"]');
  items.forEach(x => x.classList.remove('drag-over'));

  if (elUnder) {
    const listItem = elUnder.closest('[data-list="' + touchListType + '"]');
    if (listItem && listItem !== touchDragEl) {
      listItem.classList.add('drag-over');
      touchCurrentTarget = listItem;
    } else {
      touchCurrentTarget = null;
    }
  }
}

function touchDragEnd(e) {
  document.removeEventListener('touchmove', touchDragMove);
  document.removeEventListener('touchend', touchDragEnd);

  if (touchDragEl) touchDragEl.classList.remove('dragging');

  if (touchGhost) {
    document.body.removeChild(touchGhost);
    touchGhost = null;
  }

  // Clear all drag-over
  if (touchDragEl) {
    const container = touchDragEl.parentElement;
    const items = container.querySelectorAll('[data-list="' + touchListType + '"]');
    items.forEach(x => x.classList.remove('drag-over'));
  }

  if (touchCurrentTarget && touchDragEl) {
    const toIdx = parseInt(touchCurrentTarget.getAttribute('data-idx'));
    if (touchStartIdx !== null && touchStartIdx !== toIdx) {
      const list = getListData(touchListType);
      moveItem(list, touchStartIdx, toIdx);
      markUnsaved();
      rerenderList(touchListType);
      showToast('Ordine aggiornato!', 'success');
    }
  }

  touchDragEl = null;
  touchCurrentTarget = null;
  touchStartIdx = null;
  touchListType = null;
}

// Setup drag for table rows (materials & budget) after render
function setupTableDrag(tableId, listType) {
  const tbody = document.getElementById(tableId);
  if (!tbody) return;
  const rows = tbody.querySelectorAll('tr[data-list="' + listType + '"]');
  rows.forEach(tr => {
    const handle = tr.querySelector('.drag-handle');
    if (!handle) return;
    handle.addEventListener('touchstart', function(e) { touchDragStart(e, tr, listType); }, {passive: false});
  });
  setupDragHandles(tbody, listType);
}

// =====================================================
// UTILITIES
// =====================================================
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// =====================================================
// INITIALIZE
// =====================================================
function init() {
  loadNickname();
  // Load localStorage fallback if no Firebase
  if (!FIREBASE_ENABLED) {
    try {
      const sc = localStorage.getItem('zattera_checklistData');
      if (sc) checklistData = JSON.parse(sc);
    } catch {}
    try {
      const sm = localStorage.getItem('zattera_materialsData');
      if (sm) { materialsData = JSON.parse(sm); materialsInitialized = true; }
    } catch {}
    try {
      const sb = localStorage.getItem('zattera_budgetData');
      if (sb) { budgetData = JSON.parse(sb); budgetInitialized = true; }
    } catch {}
    showSyncStatus('local');
  }
  calcola(true);
  renderChecklist();
  updateProgress();
}

init();
</script>
</body>
</html>
